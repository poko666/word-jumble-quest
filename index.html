<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>英文單字拼拼樂 (語音題目版)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      padding: 10px;
      margin: 0;
      background: #f5f5f5;
    }

    h1 {
      font-size: clamp(20px, 5vw, 32px);
    }

    #game-container {
      max-width: 95vw;
      margin: 0 auto;
    }

    #letters {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      margin: 10px auto;
      gap: 8px;
    }

    .letter {
      flex: 1 1 auto;
      min-width: 40px;
      max-width: 60px;
      padding: 10px;
      border: 2px solid #333;
      border-radius: 8px;
      background: #fff;
      font-size: clamp(18px, 5vw, 28px);
      cursor: pointer;
      user-select: none;
      transition: background 0.2s;
    }
    .letter:active { background: #ddd; }

    #answer {
      min-height: 50px;
      border: 2px dashed #666;
      margin: 15px auto;
      display: flex;
      justify-content: center;
      gap: 6px;
      padding: 10px;
      flex-wrap: wrap;
      max-width: 95vw;
    }

    .slot {
      width: clamp(35px, 8vw, 55px);
      height: clamp(35px, 8vw, 55px);
      border: 1px solid #aaa;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: clamp(18px, 5vw, 28px);
      background: #fff;
    }

    #progress {
      margin-top: 10px;
      font-size: clamp(14px, 4vw, 18px);
    }

    button {
      margin: 5px;
      padding: 8px 16px;
      font-size: clamp(14px, 4vw, 18px);
      border-radius: 6px;
      border: none;
      background: #4caf50;
      color: white;
      cursor: pointer;
    }
    button:hover { background: #45a049; }

    textarea, input, select {
      width: 90%;
      max-width: 400px;
      margin: 5px auto;
      padding: 8px;
      font-size: clamp(14px, 4vw, 16px);
      border: 1px solid #ccc;
      border-radius: 5px;
      display: block;
    }
  </style>
</head>
<body>
  <h1>英文單字拼拼樂</h1>
  <div id="game-container">

    <!-- 建立單字清單區 -->
    <h3>建立新的單字清單</h3>
    <textarea id="wordListInput" placeholder="請輸入單字，用逗號分隔 (例如: APPLE,HOUSE,TRAIN)"></textarea>
    <input type="text" id="listNameInput" placeholder="清單名稱 (例如: 水果單字)">
    <button onclick="createWordList()">建立清單</button>

    <!-- 選擇清單下拉 -->
    <h3>選擇單字清單</h3>
    <select id="wordListSelect"></select>
    <button onclick="startGame()">開始遊戲</button>
    <button onclick="giveHint()">提示</button>
    <button onclick="clearAnswer()">清除答案</button>

    <div id="letters"></div>
    <div id="answer"></div>
    <div id="progress"></div>
  </div>

  <script>
    let wordLists = {};
    let words = [];
    let currentIndex = 0;
    let correctCount = 0;

    // 載入 localStorage
    window.onload = function() {
      let savedLists = localStorage.getItem("wordLists");
      if (savedLists) {
        wordLists = JSON.parse(savedLists);
        updateSelectOptions();
      }
    }

    function saveLists() {
      localStorage.setItem("wordLists", JSON.stringify(wordLists));
    }

    function createWordList() {
      let rawWords = document.getElementById("wordListInput").value.trim();
      let listName = document.getElementById("listNameInput").value.trim();
      if (!rawWords || !listName) {
        alert("請輸入清單名稱與單字！");
        return;
      }
      let wordArray = rawWords.split(",").map(w => w.trim().toUpperCase()).filter(w => w.length > 0);
      if (wordArray.length === 0) {
        alert("單字清單不能為空！");
        return;
      }
      wordLists[listName] = wordArray;
      updateSelectOptions();
      saveLists();
      alert(`已建立清單「${listName}」！`);
      document.getElementById("wordListInput").value = "";
      document.getElementById("listNameInput").value = "";
    }

    function updateSelectOptions() {
      let select = document.getElementById("wordListSelect");
      select.innerHTML = "";
      for (let key in wordLists) {
        let option = document.createElement("option");
        option.value = key;
        option.innerText = key;
        select.appendChild(option);
      }
    }

    function shuffle(array) {
      return array.sort(() => Math.random() - 0.5);
    }

    function startGame() {
      let select = document.getElementById("wordListSelect");
      let chosenList = select.value;
      if (!chosenList || !wordLists[chosenList]) {
        alert("請先建立並選擇單字清單！");
        return;
      }
      words = shuffle([...wordLists[chosenList]]);
      currentIndex = 0;
      correctCount = 0;
      loadWord();
    }

    function loadWord() {
      if (currentIndex >= words.length) {
        document.getElementById("letters").innerHTML = "";
        document.getElementById("answer").innerHTML = "";
        document.getElementById("progress").innerText =
          `遊戲結束！共答對 ${correctCount} / ${words.length}`;
        return;
      }

      let word = words[currentIndex];
      let letters = shuffle(word.split(""));

      let lettersDiv = document.getElementById("letters");
      lettersDiv.innerHTML = "";
      letters.forEach(l => {
        let span = document.createElement("div");
        span.className = "letter";
        span.innerText = l;

        span.addEventListener("click", () => {
          fillAnswer(l, span);
        });

        lettersDiv.appendChild(span);
      });

      let answerDiv = document.getElementById("answer");
      answerDiv.innerHTML = "";
      for (let i = 0; i < word.length; i++) {
        let slot = document.createElement("div");
        slot.className = "slot";
        answerDiv.appendChild(slot);
      }

      // 出題時念整個單字
      speakWord(word);

      updateProgress();
    }

    function fillAnswer(letter, element) {
      let slots = document.querySelectorAll("#answer .slot");
      for (let slot of slots) {
        if (slot.innerText === "") {
          slot.innerText = letter;
          element.style.visibility = "hidden";
          break;
        }
      }
      checkAnswer();
    }

    function clearAnswer() {
      let slots = document.querySelectorAll("#answer .slot");
      slots.forEach(s => s.innerText = "");
      let letters = document.querySelectorAll("#letters .letter");
      letters.forEach(l => l.style.visibility = "visible");
    }

    function speakWord(word) {
      let utterance = new SpeechSynthesisUtterance(word);
      utterance.lang = "en-US";
      speechSynthesis.speak(utterance);
    }

    function giveHint() {
      if (words.length > 0 && currentIndex < words.length) {
        let word = words[currentIndex];
        speakWord(word);
      }
    }

    function checkAnswer() {
      let slots = document.querySelectorAll("#answer .slot");
      let attempt = Array.from(slots).map(s => s.innerText).join("");
      if (attempt.length === words[currentIndex].length) {
        if (attempt === words[currentIndex]) {
          speakWord(attempt); // 答對再念一次
          alert("答對了！");
          correctCount++;
        } else {
          alert("答錯了，再試一次！");
        }

        // 延遲 1.5 秒後才進入下一題
        setTimeout(() => {
          currentIndex++;
          loadWord();
        }, 1500);
      }
    }

    function updateProgress() {
      document.getElementById("progress").innerText =
        `進度：${currentIndex + 1} / ${words.length}　已答對：${correctCount}`;
    }
  </script>
</body>
</html>
